{% load entry_extras %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ì—… ê´€ë¦¬í‘œ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f8f9fa; }
        .container { max-width: 1500px; margin: auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 2px 8px #ddd; }
        h1 { text-align: center; color: #333; }
        table { 
            /* width: 100%; */
            border-collapse: collapse; 
            margin-top: 20px; 
        }

        th, td { border: 1px solid #eee; padding: 0.5em 12px; text-align: center; min-width: 80px; height: 36px; box-sizing: border-box; }
        th { background: #f1f3f6; }
        tr:nth-child(even) { background: #fafbfc; }
        input, select { width: 100%; height: 100%; box-sizing: border-box; padding: 8px; border: none; background: transparent; font-size: inherit; font-family: inherit; line-height: inherit; display: block; }
        .add-btn { background: #007bff; color: #fff; border: none; padding: 7px 15px; border-radius: 5px; cursor: pointer; }
        .add-btn:hover { background: #0056b3; }
        .dropdown-edit { position: absolute; background: #fff; border: 1px solid #ccc; z-index: 4000; min-width: 180px; box-shadow: 0 2px 8px #ddd; padding: 10px; border-radius: 6px; }
        .dropdown-edit input[type=text] { width: 70%; margin-bottom: 5px; }
        .dropdown-edit ul { list-style: none; padding: 0; margin: 0; max-height: 180px; overflow-y: auto; }
        .dropdown-edit li { display: flex; align-items: center; justify-content: space-between; padding: 2px 0; }
        .dropdown-edit li span { flex: 1; cursor: pointer; padding: 2px 4px; border-radius: 3px; }
        .dropdown-edit li span:hover { background: #f1f3f6; }
        .dropdown-edit button { margin-left: 4px; font-size: 0.9em; }
        .drag-cell, th.drag-cell {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            width: 32px;
            min-width: 32px;
            max-width: 32px;
            padding: 0 !important;
        }
        .drag-handle { display:none; cursor:grab; font-size:18px; color:#bbb; user-select:none; }
        tr:hover .drag-handle { display:inline-block; }
        tr.dragging { background: #f1f3f6 !important; }
        .board-container {
            display: flex;
            gap: 16px;
            margin: 30px 0 30px 0;
            overflow-x: auto;
        }
        .board-col {
            background: #f8f9fa;
            border-radius: 8px;
            min-width: 220px;
            padding: 12px 10px 20px 10px;
            box-shadow: 0 2px 8px #eee;
            display: flex;
            flex-direction: column;
            max-height: 600px;
        }
        .board-col-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
            padding: 4px 0 8px 0;
            border-bottom: 2px solid #e0e0e0;
        }
        .board-cards {
            flex: 1 1 auto;
            min-height: 40px;
        }
        .board-card {
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 4px #e0e0e0;
            margin-bottom: 10px;
            padding: 12px 10px 8px 10px;
            cursor: grab;
            border-left: 4px solid #007bff;
            transition: box-shadow 0.2s;
        }
        .board-card-title {
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 4px;
            color: #222;
        }
        .board-card-amount {
            color: #888;
            font-size: 0.95em;
            font-weight: 500;
        }
        .add-card-btn {
            background: #f1f3f6;
            color: #007bff;
            border: none;
            padding: 6px 0;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 0.98em;
        }
        .add-card-btn:hover {
            background: #e3eafc;
        }
        td {
            white-space: nowrap;
            overflow: visible;
            text-overflow: unset;
        }
        td[data-field="name"] {
            position: relative;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 4px;
        }
        td[data-field="name"] .name-text {
            flex: 1 1 auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        td[data-field="name"] .more-btn-wrapper {
            flex: 0 0 auto;
            width: 32px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        td[data-field="name"] .more-btn {
            display: none;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 50%;
            background: #f1f3f6;
            cursor: pointer;
            transition: background 0.2s;
        }
        tr:hover td[data-field="name"] .more-btn {
            display: inline-block;
        }
        .edit-col-btn, .del-col-btn { display: none; margin-left: 4px; }
        th.col-active .edit-col-btn, th.col-active .del-col-btn { display: inline-block; }
        td[data-field] { position: relative; }
        .table-edit-input {
            position: absolute;
            left: 0; top: 0;
            width: max-content;
            min-width: 100%;
            background: #fffbe6;
            z-index: 10;
            border: none;
            font-size: inherit;
            font-family: inherit;
            line-height: inherit;
            padding: 0;
            margin: 0;
        }
        .fc-event {
            background: transparent !important;
            border: none !important;
        }
    </style>
    <script>
        window.ATTR_FIELDS = JSON.parse('{{ attributes|escapejs }}');
    </script>
</head>
<body>
<div class="container">
    <h1>ì˜ì—… ê´€ë¦¬í‘œ</h1>
    <div style="display:flex;gap:10px;margin-bottom:18px;">
        <button id="tabTable" class="add-btn" style="background:#007bff;color:#fff;">í…Œì´ë¸” ë³´ê¸°</button>
        {% comment %} <button id="tabBoard" class="add-btn" style="background:#eee;color:#333;">ë³´ë“œ ë³´ê¸°</button> {% endcomment %}
    </div>
    <div id="tableView" style="overflow-x:auto; max-width:100%;">
        <table id="entryTable" style="width:auto; min-width:unset;">
            <thead>
            <tr>
                <th class="drag-cell"></th>
                {% for attr in attributes %}
                    <th>{{ attr.name }}</th>
                {% endfor %}
            </tr>
            </thead>
            <tbody id="entryTbody">
                <tr>
                    <td class="drag-cell"><span class="drag-handle">â‹®â‹®â‹®</span></td>
                    {% for attr in attributes %}
                        {% if attr.name == 'ì´ë¦„' %}
                            <td data-field="{{ attr.name }}" data-type="{{ attr.attributeType.name }}"><div class="name-text">{{ values|get_item:attr.name }}</div><div class="more-btn-wrapper"><div class="more-btn" style="cursor:pointer;">â‹¯</div></div></td>
                        {% else %}
                            <td data-field="{{ attr.name }}" data-type="{{ attr.attributeType.name }}">{{ values|get_item:attr.name }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>
    <div style="margin:10px 0 20px 0;">
        <button id="addRowBtn" class="add-btn" style="width:180px;">+ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
    </div>
    <div id="boardView">
        <div class="board-container">
            {% for col in board %}
            <div class="board-col" data-status-id="{{ col.status.id }}" style="background:{% if col.status.color %}{{ col.status.color|to_rgba:'0.10' }}{% endif %};">
                <div class="board-col-title" style="background:{% if col.status.color %}{{ col.status.color|to_rgba:'0.18' }}{% endif %};border-left:6px solid {{ col.status.color|default:'#007bff' }};padding-left:10px;">{{ col.status.name }}</div>
                <div class="board-cards">
                    {% for entry in col.entries %}
                    <div class="board-card" data-entry-id="{{ entry.id }}">
                        <div class="board-card-title">{{ entry.name }}</div>
                        <div class="board-card-amount">{% if entry.amount %}â‚©{{ entry.amount }}{% endif %}</div>
                    </div>
                    {% endfor %}
                </div>
                <button class="add-card-btn">+ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
            </div>
            {% endfor %}
        </div>
    </div>
    <div id="calendar" style="margin-top:40px;"></div>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <!-- ëª¨ë‹¬ì°½ -->
    <div id="memoModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:24px 20px 16px 20px;border-radius:8px;min-width:350px;max-width:90vw;min-height:200px;max-height:80vh;overflow:auto;position:relative;">
        <h3 id="modalTitle">F/U ë©”ëª¨</h3>
        <textarea id="memoInput" style="width:100%;height:120px;"></textarea>
        <div style="margin:10px 0;">
          <b>ë¯¸ë¦¬ë³´ê¸°:</b>
          <div id="memoPreview" style="border:1px solid #eee;padding:8px 10px;background:#fafbfc;min-height:40px;"></div>
        </div>
        <button id="saveMemoBtn" style="background:#007bff;color:#fff;border:none;padding:7px 15px;border-radius:5px;">ì €ì¥</button>
        <button id="closeMemoBtn" style="margin-left:8px;">ë‹«ê¸°</button>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <div id="detailModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:3000;background:rgba(0,0,0,0.3);align-items:center;justify-content:center;">
      <div id="detailModalContent" style="background:#fff;min-width:400px;max-width:90vw;min-height:300px;max-height:90vh;overflow:auto;border-radius:10px;padding:30px 30px 20px 30px;position:relative;"></div>
    </div>
</div>
<script>
let dropdown = null;
function closeDropdown() {
    if (dropdown && dropdown.parentNode) {
        dropdown.parentNode.removeChild(dropdown);
        dropdown = null;
    }
}
function refreshKanban() {
    fetch('/').then(r=>r.text()).then(html=>{
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const newBoard = temp.querySelector('#boardView');
        if (newBoard) {
            document.getElementById('boardView').innerHTML = newBoard.innerHTML;
            bindKanbanSortable(); // ë“œë˜ê·¸ ê¸°ëŠ¥ ë³µêµ¬
        }
    });
}
function openDropdown(td, type, id, currentId, currentSubregion) {
    closeDropdown();
    dropdown = document.createElement('div');
    dropdown.className = 'dropdown-edit';
    dropdown.style.top = (td.getBoundingClientRect().top + window.scrollY + td.offsetHeight) + 'px';
    dropdown.style.left = (td.getBoundingClientRect().left + window.scrollX) + 'px';
    let label = type=="category"?"êµ¬ë¶„":(type=="region"?"ì§€ì—­":(type=="subregion"?"ìƒì„¸ì§€ì—­":"ì˜ì—…ì§„í–‰"));
    if(type === 'region') {
        // ì§€ì—­ë§Œ ì„ íƒí•˜ëŠ” ë“œë¡­ë‹¤ìš´
        var regionNames = ['ì„œìš¸','ê²½ê¸°','ì¸ì²œ','ëŒ€êµ¬','ë¶€ì‚°','ê´‘ì£¼','ëŒ€ì „','ìš¸ì‚°','ì„¸ì¢…','ê°•ì›','ì¶©ë¶','ì¶©ë‚¨','ì „ë¶','ì „ë‚¨'];
        let selectedRegion = currentId || 'ì„œìš¸';
        let html = '<div><b>ì§€ì—­ ì„ íƒ</b><ul style="margin:8px 0 12px 0;max-height:120px;overflow-y:auto;">';
        regionNames.forEach(function(region) {
            html += '<li style="margin-bottom:2px;"><span data-region="'+region+'" style="cursor:pointer;'+(region==selectedRegion?'font-weight:bold;color:#007bff;':'')+'">'+region+'</span></li>';
        });
        html += '</ul></div>';
        dropdown.innerHTML = html;
        document.body.appendChild(dropdown);
        // ì§€ì—­ í´ë¦­ ì‹œ ë°”ë¡œ ì €ì¥
        dropdown.querySelectorAll('span[data-region]').forEach(function(span) {
            span.onclick = function() {
                selectedRegion = this.getAttribute('data-region');
                td.innerText = selectedRegion;
                td.setAttribute('data-value', selectedRegion);
                // ìƒì„¸ì§€ì—­ tdë„ ê°™ì´ ë³€ê²½ (ì²« ë²ˆì§¸ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”)
                var subTd = td.parentElement.querySelector('td[data-field="subregion"]');
                if(subTd) {
                    var regionMap = {
                        'ì„œìš¸': ['ê´€ì•…êµ¬','ê¸ˆì²œêµ¬','ê°•ë‚¨êµ¬','ê°•ì„œêµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
                        'ê²½ê¸°': ['ìˆ˜ì›ì‹œ','ê³ ì–‘ì‹œ','ì„±ë‚¨ì‹œ','ìš©ì¸ì‹œ','ë¶€ì²œì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì–‘ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','í™”ì„±ì‹œ','í‰íƒì‹œ','ì˜ì •ë¶€ì‹œ','ì‹œí¥ì‹œ','íŒŒì£¼ì‹œ','ê´‘ëª…ì‹œ','ê¹€í¬ì‹œ','êµ°í¬ì‹œ','ê´‘ì£¼ì‹œ','ì˜¤ì‚°ì‹œ','ì´ì²œì‹œ','ì•ˆì„±ì‹œ','ì˜ì™•ì‹œ','í•˜ë‚¨ì‹œ','ì—¬ì£¼ì‹œ','ì–‘í‰êµ°','ë™ë‘ì²œì‹œ','ê³¼ì²œì‹œ','ê°€í‰êµ°','ì—°ì²œêµ°'],
                        'ì¸ì²œ': ['ê³„ì–‘êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¯¸ì¶”í™€êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì¤‘êµ¬','ê°•í™”êµ°','ì˜¹ì§„êµ°'],
                        'ëŒ€êµ¬': ['ì¤‘êµ¬','ë™êµ¬','ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬','ìˆ˜ì„±êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°'],
                        'ë¶€ì‚°': ['ì¤‘êµ¬','ì„œêµ¬','ë™êµ¬','ì˜ë„êµ¬','ë¶€ì‚°ì§„êµ¬','ë™ë˜êµ¬','ë‚¨êµ¬','ë¶êµ¬','í•´ìš´ëŒ€êµ¬','ì‚¬í•˜êµ¬','ê¸ˆì •êµ¬','ê°•ì„œêµ¬','ì—°ì œêµ¬','ìˆ˜ì˜êµ¬','ì‚¬ìƒêµ¬','ê¸°ì¥êµ°'],
                        'ê´‘ì£¼': ['ë™êµ¬','ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬','ê´‘ì‚°êµ¬'],
                        'ëŒ€ì „': ['ë™êµ¬','ì¤‘êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ëŒ€ë•êµ¬'],
                        'ìš¸ì‚°': ['ì¤‘êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°'],
                        'ì„¸ì¢…': ['ì„¸ì¢…ì‹œ'],
                        'ê°•ì›': ['ì¶˜ì²œì‹œ','ì›ì£¼ì‹œ','ê°•ë¦‰ì‹œ','ë™í•´ì‹œ','íƒœë°±ì‹œ','ì†ì´ˆì‹œ','ì‚¼ì²™ì‹œ','í™ì²œêµ°','íš¡ì„±êµ°','ì˜ì›”êµ°','í‰ì°½êµ°','ì •ì„ êµ°','ì² ì›êµ°','í™”ì²œêµ°','ì–‘êµ¬êµ°','ì¸ì œêµ°','ê³ ì„±êµ°','ì–‘ì–‘êµ°'],
                        'ì¶©ë¶': ['ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ','ì œì²œì‹œ','ë³´ì€êµ°','ì˜¥ì²œêµ°','ì˜ë™êµ°','ì¦í‰êµ°','ì§„ì²œêµ°','ê´´ì‚°êµ°','ìŒì„±êµ°','ë‹¨ì–‘êµ°'],
                        'ì¶©ë‚¨': ['ì²œì•ˆì‹œ','ê³µì£¼ì‹œ','ë³´ë ¹ì‹œ','ì•„ì‚°ì‹œ','ì„œì‚°ì‹œ','ë…¼ì‚°ì‹œ','ê³„ë£¡ì‹œ','ë‹¹ì§„ì‹œ','ê¸ˆì‚°êµ°','ë¶€ì—¬êµ°','ì„œì²œêµ°','ì²­ì–‘êµ°','í™ì„±êµ°','ì˜ˆì‚°êµ°','íƒœì•ˆêµ°'],
                        'ì „ë¶': ['ì „ì£¼ì‹œ','êµ°ì‚°ì‹œ','ìµì‚°ì‹œ','ì •ìì‹œ','ë‚¨ì›ì‹œ','ê¹€ì œì‹œ','ì™„ì£¼êµ°','ì§„ì•ˆêµ°','ë¬´ì£¼êµ°','ì¥ìˆ˜êµ°','ì„ì‹¤êµ°','ìˆœì°½êµ°','ê³ ì°½êµ°','ë¶€ì•ˆêµ°'],
                        'ì „ë‚¨': ['ëª©í¬ì‹œ','ì—¬ìˆ˜ì‹œ','ìˆœì²œì‹œ','ë‚˜ì£¼ì‹œ','ê´‘ì–‘ì‹œ','ë‹´ì–‘êµ°','ê³¡ì„±êµ°','êµ¬ë¡€êµ°','ê³ í¥êµ°','ë³´ì„±êµ°','í™”ìˆœêµ°','ì¥í¥êµ°','ê°•ì§„êµ°','í•´ë‚¨êµ°','ì˜ì•”êµ°','ë¬´ì•ˆêµ°','í•¨í‰êµ°','ì˜ê´‘êµ°','ì¥ì„±êµ°','ì™„ë„êµ°','ì§„ë„êµ°','ì‹ ì•ˆêµ°']
                    };
                    var firstSubregion = (regionMap[selectedRegion] || [])[0] || '';
                    subTd.innerText = firstSubregion;
                }
                closeDropdown();
                fetch('/update/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'id='+id+'&field=region&value='+encodeURIComponent(selectedRegion)
                }).then(() => {
                    fetch('/update/?id='+id)
                      .then(r=>r.json())
                      .then(function(data){
                          if(data.success && data.entry) {
                              updateTableRow(data.entry);
                              refreshKanban();
                              if (typeof window._modalAfterUpdateAll === 'function') { window._modalAfterUpdateAll(id); window._modalAfterUpdateAll = null; }
                          }
                      });
                });
            };
        });
        document.addEventListener('mousedown', function handler(e) {
            if(dropdown && !dropdown.contains(e.target)) { closeDropdown(); document.removeEventListener('mousedown', handler); }
        });
        return;
    } else if(type === 'subregion') {
        // ìƒì„¸ì§€ì—­ë§Œ ì„ íƒí•˜ëŠ” ë“œë¡­ë‹¤ìš´
        var regionMap = {
            'ì„œìš¸': ['ê´€ì•…êµ¬','ê¸ˆì²œêµ¬','ê°•ë‚¨êµ¬','ê°•ì„œêµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
            'ê²½ê¸°': ['ìˆ˜ì›ì‹œ','ê³ ì–‘ì‹œ','ì„±ë‚¨ì‹œ','ìš©ì¸ì‹œ','ë¶€ì²œì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì–‘ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','í™”ì„±ì‹œ','í‰íƒì‹œ','ì˜ì •ë¶€ì‹œ','ì‹œí¥ì‹œ','íŒŒì£¼ì‹œ','ê´‘ëª…ì‹œ','ê¹€í¬ì‹œ','êµ°í¬ì‹œ','ê´‘ì£¼ì‹œ','ì˜¤ì‚°ì‹œ','ì´ì²œì‹œ','ì•ˆì„±ì‹œ','ì˜ì™•ì‹œ','í•˜ë‚¨ì‹œ','ì—¬ì£¼ì‹œ','ì–‘í‰êµ°','ë™ë‘ì²œì‹œ','ê³¼ì²œì‹œ','ê°€í‰êµ°','ì—°ì²œêµ°'],
            'ì¸ì²œ': ['ê³„ì–‘êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¯¸ì¶”í™€êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì¤‘êµ¬','ê°•í™”êµ°','ì˜¹ì§„êµ°'],
            'ëŒ€êµ¬': ['ì¤‘êµ¬','ë™êµ¬','ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬','ìˆ˜ì„±êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°'],
            'ë¶€ì‚°': ['ì¤‘êµ¬','ì„œêµ¬','ë™êµ¬','ì˜ë„êµ¬','ë¶€ì‚°ì§„êµ¬','ë™ë˜êµ¬','ë‚¨êµ¬','ë¶êµ¬','í•´ìš´ëŒ€êµ¬','ì‚¬í•˜êµ¬','ê¸ˆì •êµ¬','ê°•ì„œêµ¬','ì—°ì œêµ¬','ìˆ˜ì˜êµ¬','ì‚¬ìƒêµ¬','ê¸°ì¥êµ°'],
            'ê´‘ì£¼': ['ë™êµ¬','ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬','ê´‘ì‚°êµ¬'],
            'ëŒ€ì „': ['ë™êµ¬','ì¤‘êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ëŒ€ë•êµ¬'],
            'ìš¸ì‚°': ['ì¤‘êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°'],
            'ì„¸ì¢…': ['ì„¸ì¢…ì‹œ'],
            'ê°•ì›': ['ì¶˜ì²œì‹œ','ì›ì£¼ì‹œ','ê°•ë¦‰ì‹œ','ë™í•´ì‹œ','íƒœë°±ì‹œ','ì†ì´ˆì‹œ','ì‚¼ì²™ì‹œ','í™ì²œêµ°','íš¡ì„±êµ°','ì˜ì›”êµ°','í‰ì°½êµ°','ì •ì„ êµ°','ì² ì›êµ°','í™”ì²œêµ°','ì–‘êµ¬êµ°','ì¸ì œêµ°','ê³ ì„±êµ°','ì–‘ì–‘êµ°'],
            'ì¶©ë¶': ['ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ','ì œì²œì‹œ','ë³´ì€êµ°','ì˜¥ì²œêµ°','ì˜ë™êµ°','ì¦í‰êµ°','ì§„ì²œêµ°','ê´´ì‚°êµ°','ìŒì„±êµ°','ë‹¨ì–‘êµ°'],
            'ì¶©ë‚¨': ['ì²œì•ˆì‹œ','ê³µì£¼ì‹œ','ë³´ë ¹ì‹œ','ì•„ì‚°ì‹œ','ì„œì‚°ì‹œ','ë…¼ì‚°ì‹œ','ê³„ë£¡ì‹œ','ë‹¹ì§„ì‹œ','ê¸ˆì‚°êµ°','ë¶€ì—¬êµ°','ì„œì²œêµ°','ì²­ì–‘êµ°','í™ì„±êµ°','ì˜ˆì‚°êµ°','íƒœì•ˆêµ°'],
            'ì „ë¶': ['ì „ì£¼ì‹œ','êµ°ì‚°ì‹œ','ìµì‚°ì‹œ','ì •ìì‹œ','ë‚¨ì›ì‹œ','ê¹€ì œì‹œ','ì™„ì£¼êµ°','ì§„ì•ˆêµ°','ë¬´ì£¼êµ°','ì¥ìˆ˜êµ°','ì„ì‹¤êµ°','ìˆœì°½êµ°','ê³ ì°½êµ°','ë¶€ì•ˆêµ°'],
            'ì „ë‚¨': ['ëª©í¬ì‹œ','ì—¬ìˆ˜ì‹œ','ìˆœì²œì‹œ','ë‚˜ì£¼ì‹œ','ê´‘ì–‘ì‹œ','ë‹´ì–‘êµ°','ê³¡ì„±êµ°','êµ¬ë¡€êµ°','ê³ í¥êµ°','ë³´ì„±êµ°','í™”ìˆœêµ°','ì¥í¥êµ°','ê°•ì§„êµ°','í•´ë‚¨êµ°','ì˜ì•”êµ°','ë¬´ì•ˆêµ°','í•¨í‰êµ°','ì˜ê´‘êµ°','ì¥ì„±êµ°','ì™„ë„êµ°','ì§„ë„êµ°','ì‹ ì•ˆêµ°']
        };
        var currentRegion = td.parentElement.querySelector('td[data-field="region"]').innerText.trim();
        var subregions = regionMap[currentRegion] || [];
        let selectedSubregion = currentSubregion || '';
        let html = '<div><b>ìƒì„¸ì§€ì—­ ì„ íƒ</b><ul style="margin:8px 0 12px 0;max-height:120px;overflow-y:auto;">';
        subregions.forEach(function(sub) {
            html += '<li style="margin-bottom:2px;"><span data-subregion="'+sub+'" style="cursor:pointer;'+(sub==selectedSubregion?'font-weight:bold;color:#007bff;':'')+'">'+sub+'</span></li>';
        });
        html += '</ul></div>';
        dropdown.innerHTML = html;
        document.body.appendChild(dropdown);
        // ìƒì„¸ì§€ì—­ í´ë¦­ ì‹œ ë°”ë¡œ ì €ì¥
        dropdown.querySelectorAll('span[data-subregion]').forEach(function(span) {
            span.onclick = function() {
                selectedSubregion = this.getAttribute('data-subregion');
                td.innerText = selectedSubregion;
                closeDropdown();
                fetch('/update/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'id='+id+'&field=subregion&value='+encodeURIComponent(selectedSubregion)
                }).then(() => {
                    fetch('/update/?id='+id)
                      .then(r=>r.json())
                      .then(function(data){
                          if(data.success && data.entry) {
                              updateTableRow(data.entry);
                              refreshKanban();
                              if (typeof window._modalAfterUpdateAll === 'function') { window._modalAfterUpdateAll(id); window._modalAfterUpdateAll = null; }
                          }
                      });
                });
            };
        });
        document.addEventListener('mousedown', function handler(e) {
            if(dropdown && !dropdown.contains(e.target)) { closeDropdown(); document.removeEventListener('mousedown', handler); }
        });
        return;
    } else if(type === 'category') {
        fetch('/categories/').then(r=>r.json()).then(function(data){
            let html = '<div><b>êµ¬ë¶„ ì„ íƒ</b><ul style="margin:8px 0 12px 0;max-height:120px;overflow-y:auto;">';
            (data.categories||[]).forEach(function(cat){
                html += `<li style="display:flex;align-items:center;gap:6px;">
                    <span data-category="${cat.id}" style="cursor:pointer;background:${cat.color ? hexToRgba(cat.color, 0.18) : '#eee'};border-radius:4px;padding:2px 8px;min-width:60px;display:inline-block;">${cat.name}</span>
                    <input type="color" value="${cat.color||'#eeeeee'}" data-color-edit="${cat.id}" style="width:24px;height:24px;border:none;vertical-align:middle;cursor:pointer;">
                    <button data-edit="${cat.id}">âœï¸</button>
                    <button data-del="${cat.id}">ğŸ—‘ï¸</button></li>`;
            });
            html += '</ul>';
            html += '<input type="text" placeholder="ìƒˆ êµ¬ë¶„ ì¶”ê°€" style="width:70%;"> <button class="add-btn">ì¶”ê°€</button></div>';
            dropdown.innerHTML = html;
            document.body.appendChild(dropdown);
            // ì„ íƒ
            dropdown.querySelectorAll('span[data-category]').forEach(function(span){
                span.onclick = function(){
                    td.innerText = span.innerText;
                    td.setAttribute('data-value', span.getAttribute('data-category'));
                    td.style.background = span.style.background;
                    closeDropdown();
                    fetch('/update/', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: 'id='+id+'&field=category&value='+encodeURIComponent(span.getAttribute('data-category'))
                    }).then(() => {
                        fetch('/update/?id='+id)
                          .then(r=>r.json())
                          .then(function(data){
                              if(data.success && data.entry) {
                                  updateTableRow(data.entry);
                                  refreshKanban();
                                  if (typeof window._modalAfterUpdateAll === 'function') { window._modalAfterUpdateAll(id); window._modalAfterUpdateAll = null; }
                              }
                          });
                    });
                };
            });
            // ì»¬ëŸ¬í”¼ì»¤
            dropdown.querySelectorAll('input[data-color-edit]').forEach(function(input){
                input.onchange = function(e){
                    fetch('/categories/?id='+input.getAttribute('data-color-edit')+'&color='+encodeURIComponent(input.value), {method:'PUT'})
                        .then(()=>openDropdown(td, 'category', id));
                };
            });
            // ì¶”ê°€
            dropdown.querySelector('.add-btn').onclick = function(){
                const val = dropdown.querySelector('input[type=text]').value.trim();
                if(val) fetch('/categories/', {method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'name='+encodeURIComponent(val)})
                    .then(()=>openDropdown(td, 'category', id));
            };
            // ì‚­ì œ
            dropdown.querySelectorAll('button[data-del]').forEach(function(btn){
                btn.onclick = function(e){
                    e.stopPropagation();
                    if(confirm('ì‚­ì œí• ê¹Œìš”?')) fetch('/categories/?id='+btn.getAttribute('data-del'), {method:'DELETE'})
                        .then(()=>openDropdown(td, 'category', id));
                };
            });
            // ìˆ˜ì •
            dropdown.querySelectorAll('button[data-edit]').forEach(function(btn){
                btn.onclick = function(e){
                    e.stopPropagation();
                    const li = btn.closest('li');
                    const span = li.querySelector('span[data-category]');
                    const old = span.innerText;
                    const input = document.createElement('input');
                    input.type = 'text'; input.value = old;
                    input.className = 'table-edit-input';
                    span.replaceWith(input);
                    input.focus();
                    input.onkeydown = function(ev){
                        if(ev.key==='Enter'){
                            fetch('/categories/?id='+btn.getAttribute('data-edit')+'&name='+encodeURIComponent(input.value), {method:'PUT'})
                                .then(()=>openDropdown(td, 'category', id));
                        }
                    };
                };
            });
            document.addEventListener('mousedown', function handler(e) {
                if(dropdown && !dropdown.contains(e.target)) { closeDropdown(); document.removeEventListener('mousedown', handler); }
            });
        });
        return;
    }
    if(type === 'status') {
        fetch('/statuses/').then(r=>r.json()).then(function(data){
            let html = '<div><b>ì˜ì—…ì§„í–‰ ì„ íƒ</b><ul style="margin:8px 0 12px 0;max-height:120px;overflow-y:auto;">';
            (data.statuses||[]).forEach(function(st){
                html += `<li style="display:flex;align-items:center;gap:6px;">
                    <span data-status="${st.id}" style="cursor:pointer;background:${st.color ? hexToRgba(st.color, 0.18) : '#eee'};border-radius:4px;padding:2px 8px;min-width:60px;display:inline-block;">${st.name}</span>
                    <input type="color" value="${st.color||'#eeeeee'}" data-color-edit="${st.id}" style="width:24px;height:24px;border:none;vertical-align:middle;cursor:pointer;">
                    <button data-edit="${st.id}">âœï¸</button>
                    <button data-del="${st.id}">ğŸ—‘ï¸</button></li>`;
            });
            html += '</ul>';
            html += '<input type="text" placeholder="ìƒˆ ì˜ì—…ì§„í–‰ ì¶”ê°€" style="width:70%;"> <button class="add-btn">ì¶”ê°€</button></div>';
            dropdown.innerHTML = html;
            document.body.appendChild(dropdown);
            // ì„ íƒ
            dropdown.querySelectorAll('span[data-status]').forEach(function(span){
                span.onclick = function(){
                    td.innerText = span.innerText;
                    td.setAttribute('data-value', span.getAttribute('data-status'));
                    td.style.background = span.style.background;
                    closeDropdown();
                    fetch('/update/', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: 'id='+id+'&field=status&value='+encodeURIComponent(span.getAttribute('data-status'))
                    }).then(() => {
                        fetch('/update/?id='+id)
                          .then(r=>r.json())
                          .then(function(data){
                              if(data.success && data.entry) {
                                  updateTableRow(data.entry);
                                  refreshKanban();
                                  if (window.calendar) window.calendar.refetchEvents();
                                  if (typeof window._modalAfterUpdateAll === 'function') { window._modalAfterUpdateAll(id); window._modalAfterUpdateAll = null; }
                              }
                          });
                    });
                };
            });
            // ì»¬ëŸ¬í”¼ì»¤
            dropdown.querySelectorAll('input[data-color-edit]').forEach(function(input){
                input.onchange = function(e){
                    fetch('/statuses/?id='+input.getAttribute('data-color-edit')+'&color='+encodeURIComponent(input.value), {method:'PUT'})
                        .then(()=>openDropdown(td, 'status', id));
                };
            });
            // ì¶”ê°€
            dropdown.querySelector('.add-btn').onclick = function(){
                const val = dropdown.querySelector('input[type=text]').value.trim();
                if(val) fetch('/statuses/', {method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'name='+encodeURIComponent(val)})
                    .then(()=>{
                        openDropdown(td, 'status', id);
                        refreshKanban();
                        if (window.calendar) window.calendar.refetchEvents();
                    });
            };
            // ì‚­ì œ
            dropdown.querySelectorAll('button[data-del]').forEach(function(btn){
                btn.onclick = function(e){
                    e.stopPropagation();
                    if(confirm('ì‚­ì œí• ê¹Œìš”?')) fetch('/statuses/?id='+btn.getAttribute('data-del'), {method:'DELETE'})
                        .then(()=>openDropdown(td, 'status', id));
                };
            });
            // ìˆ˜ì •
            dropdown.querySelectorAll('button[data-edit]').forEach(function(btn){
                btn.onclick = function(e){
                    e.stopPropagation();
                    const li = btn.closest('li');
                    const span = li.querySelector('span[data-status]');
                    const old = span.innerText;
                    const input = document.createElement('input');
                    input.type = 'text'; input.value = old;
                    input.className = 'table-edit-input';
                    span.replaceWith(input);
                    input.focus();
                    input.onkeydown = function(ev){
                        if(ev.key==='Enter'){
                            fetch('/statuses/?id='+btn.getAttribute('data-edit')+'&name='+encodeURIComponent(input.value), {method:'PUT'})
                                .then(()=>openDropdown(td, 'status', id));
                        }
                    };
                };
            });
            document.addEventListener('mousedown', function handler(e) {
                if(dropdown && !dropdown.contains(e.target)) { closeDropdown(); document.removeEventListener('mousedown', handler); }
            });
        });
        return;
    }
}
function bindKanbanSortable() {
    document.querySelectorAll('.board-cards').forEach(function(col){
        new Sortable(col, {
            group: 'kanban',
            animation: 150,
            onAdd: function(evt){
                const entryId = evt.item.getAttribute('data-entry-id');
                const newStatusId = col.parentElement.getAttribute('data-status-id');
                fetch('/update/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'id='+entryId+'&field=status&value='+encodeURIComponent(newStatusId)
                }).then(()=>{ refreshKanban(); refreshTable(); });
            }
        });
    });
    // ì¹¸ë°˜ ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸ ëª¨ë‹¬
    document.querySelectorAll('.board-card').forEach(function(card){
        card.onclick = function(e) {
            const entryId = card.getAttribute('data-entry-id');
            if(entryId) {
                fetch('/update/?id='+entryId)
                  .then(r=>r.json())
                  .then(function(data){
                      if(data.success && data.entry) showDetailModal(data.entry);
                  });
            }
        };
    });
}
function bindTableCellEvents() {
    document.querySelectorAll('td[data-field]').forEach(function(td) {
        const type = td.getAttribute('data-field');
        // ë“œë¡­ë‹¤ìš´ ì…€
        if(['category','region','status','subregion'].includes(type)) {
            td.onclick = function(e) {
                const id = td.parentElement.getAttribute('data-id');
                if(type === 'region') {
                    openDropdown(td, 'region', id, td.innerText.trim(), td.parentElement.querySelector('td[data-field="subregion"]').innerText.trim());
                } else if(type === 'subregion') {
                    openDropdown(td, 'subregion', id, td.parentElement.querySelector('td[data-field="region"]').innerText.trim(), td.innerText.trim());
                } else if(type === 'category') {
                    openDropdown(td, 'category', id, td.getAttribute('data-value'));
                } else if(type === 'status') {
                    openDropdown(td, 'status', id, td.getAttribute('data-value'));
                }
            };
        } else {
            // ì¸ë¼ì¸ í¸ì§‘ ì…€
            td.onclick = function() {
                if (td.querySelector('input')) return; // ì´ë¯¸ í¸ì§‘ ì¤‘ì´ë©´ ë¬´ì‹œ
                // ì¸ë¼ì¸ í¸ì§‘ ì‹œì‘ ì‹œ tdì˜ widthë¥¼ ê³ ì •
                td.style.width = td.offsetWidth + 'px';
                if(type === 'name') {
                    const nameDiv = td.querySelector('.name-text');
                    if(!nameDiv) return;
                    const oldValue = nameDiv.innerText;
                    const id = td.parentElement.getAttribute('data-id');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = oldValue;
                    input.className = 'table-edit-input';
                    nameDiv.innerHTML = '';
                    nameDiv.appendChild(input);
                    // ...ë²„íŠ¼ ìˆ¨ê¹€
                    const moreBtnWrapper = td.querySelector('.more-btn-wrapper');
                    if(moreBtnWrapper) moreBtnWrapper.style.visibility = 'hidden';
                    input.focus();
                    function restoreCell(value) {
                        td.innerHTML = `<div class="name-text">${value}</div><div class="more-btn-wrapper"><div class="more-btn" style="cursor:pointer;">â‹¯</div></div>`;
                        // ...ë²„íŠ¼ ì´ë²¤íŠ¸ ì¬ë°”ì¸ë”©
                        const newMoreBtn = td.querySelector('.more-btn');
                        if(newMoreBtn) {
                            newMoreBtn.onclick = function(e){
                                e.stopPropagation();
                                const tr = td.closest('tr');
                                const id = tr.getAttribute('data-id');
                                if(!id) { alert('ID ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
                                fetch('/update/?id='+id)
                                  .then(r => r.text())
                                  .then(function(text){
                                      console.log('ì‘ë‹µë³¸ë¬¸:', text);
                                      try {
                                          const data = JSON.parse(text);
                                          if(data.success) showDetailModal(data.entry);
                                          else alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+(data.error||''));
                                      } catch(e) {
                                          alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: JSON íŒŒì‹± ì˜¤ë¥˜');
                                          console.error(e);
                                      }
                                  })
                                  .catch(function(err){
                                      alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜\n' + err);
                                      console.error(err);
                                  });
                            };
                        }
                        // í¸ì§‘ ì¢…ë£Œ ì‹œ td width í•´ì œ
                        td.style.width = '';
                    }
                    input.onblur = function() {
                        const newValue = input.value;
                        restoreCell(newValue);
                        fetch('/update/', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: 'id='+id+'&field=name&value='+encodeURIComponent(newValue)
                        });
                    };
                    input.onkeydown = function(e) {
                        if (e.key === 'Enter') input.blur();
                        if (e.key === 'Escape') restoreCell(oldValue);
                    };
                } else {
                    const oldValue = td.innerText;
                    const field = td.getAttribute('data-field');
                    const id = td.parentElement.getAttribute('data-id');
                    let inputType = 'text';
                    if (['ta_date','meeting_date','fu_date'].includes(field)) inputType = 'date';
                    const input = document.createElement('input');
                    input.type = inputType;
                    input.value = (inputType==='date' && oldValue) ? oldValue.trim().slice(0,10) : oldValue.trim();
                    input.className = 'table-edit-input';
                    td.innerHTML = '';
                    td.appendChild(input);
                    input.focus();
                    input.onblur = function() {
                        const newValue = input.value;
                        if (newValue === oldValue || (inputType==='date' && (!newValue && !oldValue))) {
                            td.innerText = oldValue;
                            // í¸ì§‘ ì¢…ë£Œ ì‹œ td width í•´ì œ
                            td.style.width = '';
                            return;
                        }
                        td.innerText = newValue;
                        // í¸ì§‘ ì¢…ë£Œ ì‹œ td width í•´ì œ
                        td.style.width = '';
                        fetch('/update/', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: 'id='+id+'&field='+field+'&value='+encodeURIComponent(newValue)
                        }).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            if(!data.success) alert('ìˆ˜ì • ì‹¤íŒ¨: '+data.error);
                            if(field==='fu_date' && window.calendar) window.calendar.refetchEvents();
                            // ë§¤ì¶œ(ê¸ˆì•¡) ìˆ˜ì • ì‹œ, ì˜ì—…ì§„í–‰ ê°’ì´ ìˆìœ¼ë©´ ì¹¸ë°˜ë³´ë“œ ê°±ì‹ 
                            if(field==='amount') {
                                const statusTd = td.parentElement.querySelector('td[data-field="status"]');
                                if(statusTd && statusTd.innerText.trim()) {
                                    refreshKanban();
                                }
                            }
                        });
                    };
                    input.onkeydown = function(e) {
                        if (e.key === 'Enter') input.blur();
                        if (e.key === 'Escape') { td.innerText = oldValue; td.style.width = ''; }
                    };
                }
            };
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    bindTableCellEvents();
    bindKanbanSortable();
    // ìº˜ë¦°ë” ì´ˆê¸°í™”
    var calendar = null;
    var calendarEl = document.getElementById('calendar');
    if(calendarEl) {
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            height: 500,
            events: '/fu_events/',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listMonth'
            },
            eventContent: function(arg) {
                const name = arg.event.title;
                const meetingDate = arg.event.extendedProps.meeting_date;
                const status = arg.event.extendedProps.status_name;
                const statusColor = arg.event.extendedProps.status_color || '#bbb';
                function hexToRgba(hex, alpha) {
                    hex = hex.replace('#', '');
                    if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
                    const r = parseInt(hex.substring(0,2), 16);
                    const g = parseInt(hex.substring(2,4), 16);
                    const b = parseInt(hex.substring(4,6), 16);
                    return `rgba(${r},${g},${b},${alpha})`;
                }
                let html = `<div style='width:100%;height:100%;box-sizing:border-box;padding:4px 6px 2px 6px; border-radius:8px; background:${hexToRgba(statusColor,0.12)}; color:#222;'>` +
                    `<div style='font-weight:bold; font-size:1em; margin-bottom:2px;'>${name}</div>` +
                    `<div style='font-size:0.95em; margin-bottom:2px;'>${meetingDate||''}</div>` +
                    (status ? `<span style='display:inline-block;background:${statusColor};color:#fff;padding:2px 8px;border-radius:6px;font-size:0.92em;'>${status}</span>` : '') +
                    `</div>`;
                return { html };
            },
            eventClick: function(info) {
                fetch('/update/?id='+info.event.id)
                  .then(r=>r.json())
                  .then(function(data){
                      if(data.success && data.entry) showDetailModal(data.entry);
                  });
            }
        });
        calendar.render();
        window.calendar = calendar;
    }
    // í…Œì´ë¸” í–‰ ë“œë˜ê·¸ì•¤ë“œë¡­(SortableJS) ì´ˆê¸°í™”
    if(typeof Sortable !== 'undefined') {
        new Sortable(document.getElementById('entryTbody'), {
            handle: '.drag-handle',
            animation: 150,
            onEnd: function (evt) {
                // ìˆœì„œ ë³€ê²½ ì‹œ ì„œë²„ì— ë°˜ì˜
                const ids = Array.from(document.querySelectorAll('#entryTbody tr[data-id]')).map(tr => tr.getAttribute('data-id'));
                fetch('/reorder/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({order: ids})
                }).then(res => res.json()).then(data => {
                    if(!data.success) alert('ìˆœì„œ ì €ì¥ ì‹¤íŒ¨: '+data.error);
                }).catch(() => alert('ìˆœì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'));
            }
        });
    }
    // ìƒˆë¡œ ë§Œë“¤ê¸° ë²„íŠ¼ ë™ì‘ ë³µêµ¬
    const addRowBtn = document.getElementById('addRowBtn');
    const entryTable = document.getElementById('entryTable');
    const entryTbody = document.getElementById('entryTbody');
    let isAdding = false;
    addRowBtn.onclick = function() {
        if(isAdding) return;
        isAdding = true;
        const tr = document.createElement('tr');
        tr.className = 'new-row';
        // ë§¨ ì•ì— drag-cell td ì¶”ê°€
        const dragTd = document.createElement('td');
        dragTd.className = 'drag-cell';
        tr.appendChild(dragTd);
        const fields = window.ATTR_FIELDS.map(attr => attr.name);
        fields.forEach(function(field) {
            const td = document.createElement('td');
            td.setAttribute('data-field', field);
            // íƒ€ì… ì •ë³´ë„ í™œìš© ê°€ëŠ¥
            const attrObj = window.ATTR_FIELDS.find(a => a.name === field);
            const type = attrObj && attrObj.attributeType ? attrObj.attributeType.name : '';
            if(['ta_date','meeting_date','fu_date'].includes(field) || type === 'datetime') {
                td.innerHTML = '<input type="date" style="width:100%;height:100%;box-sizing:border-box;padding:8px;border:none;background:transparent;font-size:inherit;font-family:inherit;line-height:inherit;display:block;">';
            } else if(type === 'dropdown') {
                td.innerText = '';
            } else if(field==='region') {
                td.innerText = 'ì„œìš¸';
                td.setAttribute('data-value', 'ì„œìš¸');
            } else if(field==='subregion') {
                td.innerText = 'ê´€ì•…êµ¬';
            } else {
                td.innerHTML = '<input type="text" style="width:100%;height:100%;box-sizing:border-box;padding:8px;border:none;background:transparent;font-size:inherit;font-family:inherit;line-height:inherit;display:block;">';
            }
            tr.appendChild(td);
        });
        // tbodyì— 'ì‘ì„±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' í–‰ì´ ìˆìœ¼ë©´ ì‚­ì œ
        const emptyRow = entryTbody.querySelector('tr td[colspan]');
        if (emptyRow) {
            emptyRow.parentElement.remove();
        }
        entryTbody.appendChild(tr);
        tr.querySelector('input') && tr.querySelector('input').focus();
        tr.addEventListener('focusout', function(e) {
            setTimeout(function(){ isAdding=false; }, 200);
        });
        // ì €ì¥ ë¡œì§
        function saveNewRow() {
            const data = {};
            tr.querySelectorAll('td').forEach(function(td) {
                const field = td.getAttribute('data-field');
                if(!field) return;
                const input = td.querySelector('input,select');
                data[field] = input ? input.value : td.innerText;
            });
            if(!data.name) return; // ì´ë¦„ì´ ë¹„ì–´ìˆìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ
            fetch('/create/', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'name='+encodeURIComponent(data.name)+'&category='+encodeURIComponent(data.category)+'&region='+encodeURIComponent(data.region)+'&subregion='+encodeURIComponent(data.subregion)+'&address='+encodeURIComponent(data.address)+'&manager='+encodeURIComponent(data.manager)+'&phone='+encodeURIComponent(data.phone)+'&email='+encodeURIComponent(data.email)+'&ta_date='+encodeURIComponent(data.ta_date)+'&meeting_date='+encodeURIComponent(data.meeting_date)+'&fu_date='+encodeURIComponent(data.fu_date)+'&status='+encodeURIComponent(data.status)+'&possibility='+encodeURIComponent(data.possibility)+'&amount='+encodeURIComponent(data.amount)
            }).then(function(response) {
                return response.json();
            }).then(function(resp) {
                if(resp.success) location.reload();
                else alert('ì €ì¥ ì‹¤íŒ¨: '+resp.error);
            });
        }
        // ì…€ì—ì„œ ì—”í„°/í¬ì»¤ìŠ¤ì•„ì›ƒ ì‹œ ì €ì¥
        tr.querySelectorAll('input,select').forEach(function(input) {
            input.onkeydown = function(e) { if(e.key==='Enter') saveNewRow(); };
            input.onblur = function() { setTimeout(saveNewRow, 100); };
        });
        // region, subregion ì…€ í´ë¦­ ì‹œ openDropdown
        tr.querySelector('td[data-field="region"]').onclick = function() {
            openDropdown(this, 'region', '', 'ì„œìš¸', 'ê´€ì•…êµ¬');
        };
        tr.querySelector('td[data-field="subregion"]').onclick = function() {
            openDropdown(this, 'subregion', '', tr.querySelector('td[data-field="region"]').innerText, tr.querySelector('td[data-field="subregion"]').innerText);
        };
        // category ì…€ í´ë¦­ ì‹œ openDropdown
        tr.querySelector('td[data-field="category"]').onclick = function() {
            openDropdown(this, 'category', '', '');
        };
    };
    document.querySelectorAll('td[data-field="name"] .more-btn').forEach(function(btn){
        btn.onclick = function(e){
            e.stopPropagation();
            const tr = btn.closest('tr');
            const id = tr.getAttribute('data-id');
            if(!id) { alert('ID ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            fetch('/update/?id='+id)
              .then(r => r.text())
              .then(function(text){
                  console.log('ì‘ë‹µë³¸ë¬¸:', text);
                  try {
                      const data = JSON.parse(text);
                      if(data.success) showDetailModal(data.entry);
                      else alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+(data.error||''));
                  } catch(e) {
                      alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: JSON íŒŒì‹± ì˜¤ë¥˜');
                      console.error(e);
                  }
              })
              .catch(function(err){
                  alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜\n' + err);
                  console.error(err);
              });
        };
    });
    // ë©”ëª¨ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ë¦¬íŒ©í† ë§
    function openMemoModal(entryId, title, date) {
        const modal = document.getElementById('memoModal');
        const modalTitle = document.getElementById('modalTitle');
        const memoInput = document.getElementById('memoInput');
        const memoPreview = document.getElementById('memoPreview');
        const saveBtn = document.getElementById('saveMemoBtn');
        const closeBtn = document.getElementById('closeMemoBtn');
        let isEdit = false;
        let currentMemo = '';
        // ë³´ê¸° ëª¨ë“œë¡œ ì „í™˜
        function setViewMode(mdText) {
            isEdit = false;
            memoInput.style.display = 'none';
            saveBtn.style.display = 'none';
            memoPreview.style.display = 'block';
            memoPreview.innerHTML = marked.parse(mdText || '');
            // ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€
            let editBtn = document.getElementById('editMemoBtn');
            if (!editBtn) {
                editBtn = document.createElement('button');
                editBtn.id = 'editMemoBtn';
                editBtn.textContent = 'ìˆ˜ì •';
                editBtn.style.marginLeft = '8px';
                saveBtn.parentNode.insertBefore(editBtn, closeBtn);
            }
            editBtn.style.display = 'inline-block';
            editBtn.onclick = function() {
                setEditMode(currentMemo);
            };
        }
        // ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
        function setEditMode(mdText) {
            isEdit = true;
            memoInput.style.display = 'block';
            saveBtn.style.display = 'inline-block';
            memoPreview.style.display = 'block';
            memoInput.value = mdText || '';
            memoPreview.innerHTML = marked.parse(mdText || '');
            let editBtn = document.getElementById('editMemoBtn');
            if (editBtn) editBtn.style.display = 'none';
            memoInput.oninput = function() {
                memoPreview.innerHTML = marked.parse(memoInput.value || '');
            };
        }
        // ì €ì¥
        saveBtn.onclick = function() {
            const newMemo = memoInput.value;
            fetch('/fu_memo/' + entryId + '/', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'memo=' + encodeURIComponent(newMemo)
            }).then(r => r.json()).then(function(resp) {
                if (resp.success) {
                    currentMemo = newMemo;
                    setViewMode(currentMemo);
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (resp.error || ''));
                }
            });
        };
        closeBtn.onclick = function() {
            modal.style.display = 'none';
        };
        // ìµœì´ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        fetch('/fu_memo/' + entryId + '/').then(r => r.json()).then(function(resp) {
            if (resp.success) {
                currentMemo = resp.memo || '';
                modalTitle.textContent = (title || 'F/U ë©”ëª¨') + (date ? ' (' + date + ')' : '');
                setViewMode(currentMemo);
                modal.style.display = 'flex';
            } else {
                alert('ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (resp.error || ''));
            }
        });
    }
    // ìƒì„¸ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('detailModal').addEventListener('mousedown', function(e) {
        if (e.target === this) {
            closeDetailModal();
        }
    });
});
function refreshTable() {
    fetch('/').then(r=>r.text()).then(html=>{
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const newTable = temp.querySelector('#entryTable');
        if (newTable) {
            document.getElementById('entryTable').innerHTML = newTable.innerHTML;
            bindTableCellEvents(); // ë°˜ë“œì‹œ í˜¸ì¶œ
        }
    });
}
function hexToRgba(hex, alpha) {
    hex = hex.replace('#', '');
    if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
    const r = parseInt(hex.substring(0,2), 16);
    const g = parseInt(hex.substring(2,4), 16);
    const b = parseInt(hex.substring(4,6), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

// ìƒì„¸ë³´ê¸° ëª¨ë‹¬ í•¨ìˆ˜ ì¶”ê°€
function showDetailModal(entry) {
    // í…Œì´ë¸”ê³¼ ë™ì¼í•œ í•„ë“œ ìˆœì„œ
    const fieldOrder = [
        'name','category_name','region_name','subregion','address','manager','phone','email','ta_date','meeting_date','fu_date','status_name','possibility','amount','created_at','updated_at'
    ];
    const fieldLabels = {
        name: 'ì´ë¦„',
        category_name: 'êµ¬ë¶„',
        region_name: 'ì§€ì—­',
        subregion: 'ìƒì„¸ì§€ì—­',
        address: 'ì£¼ì†Œ',
        manager: 'ë‹´ë‹¹ì',
        phone: 'ì—°ë½ì²˜',
        email: 'ì´ë©”ì¼',
        ta_date: 'TA',
        meeting_date: 'ë¯¸íŒ…',
        fu_date: 'F/U ì¼ì •',
        status_name: 'ì˜ì—…ì§„í–‰',
        possibility: 'ê°€ëŠ¥ì„±',
        amount: 'ë§¤ì¶œ',
        created_at: 'ìƒì„±ì¼',
        updated_at: 'ìˆ˜ì •ì¼',
    };
    let html = '<h3>ìƒì„¸ ì •ë³´</h3><table style="width:100%">';
    const readonlyFields = ['created_at', 'updated_at'];
    const dropdownFields = ['category_name','region_name','status_name','subregion'];
    let memoHtml = '';
    fieldOrder.forEach(function(key) {
        if (!(key in entry)) return;
        let value = entry[key] ?? '';
        let inputHtml = '';
        if (dropdownFields.includes(key)) {
            let btnStyle = '';
            if(key==='category_name' && entry.category_color) btnStyle = `background:${hexToRgba(entry.category_color, 0.18)};`;
            if(key==='status_name' && entry.status_color) btnStyle = `background:${hexToRgba(entry.status_color, 0.18)};`;
            inputHtml = `<button type="button" class="add-btn" style="width:100%;background:#f8f9fa;color:#333;border:1px solid #eee;${btnStyle}" onclick="openDetailDropdown('${entry.id}','${key}',this)">${value||'ì„ íƒ'}</button>`;
        } else if (key === 'address') {
            inputHtml = `<input type="text" value="${value}" data-field="${key}" onchange="updateEntryField('${entry.id}', '${key}', this.value)">`;
        } else if (readonlyFields.includes(key)) {
            inputHtml = `<input type="text" value="${value}" readonly style="background:#f8f9fa;">`;
        } else if (key.endsWith('_date')) {
            inputHtml = `<input type="date" value="${value}" data-field="${key}" onchange="updateEntryField('${entry.id}', '${key}', this.value)">`;
        } else {
            inputHtml = `<input type="text" value="${value}" data-field="${key}" onchange="updateEntryField('${entry.id}', '${key}', this.value)">`;
        }
        html += `<tr><th style="text-align:right;padding:4px 8px;color:#888;">${fieldLabels[key] || key}</th><td style="padding:4px 8px;">${inputHtml}</td></tr>`;
    });
    // ë©”ëª¨ëŠ” textarea + ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ê²°ê³¼ ë™ì‹œ í‘œì‹œ
    if ('memo' in entry) {
        memoHtml = `<div style="margin-top:18px;"><b>ë©”ëª¨</b><br><textarea id="modalMemoInput" data-field="memo" style="width:98%;min-height:80px;">${entry.memo ?? ''}</textarea><div id="modalMemoPreview" style="border:1px solid #eee;padding:8px 10px;background:#fafbfc;min-height:40px;margin-top:6px;"></div></div>`;
    }
    html += '</table>' + memoHtml;
    document.getElementById('detailModalContent').innerHTML = html;
    document.getElementById('detailModal').style.display = 'flex';
    // ë©”ëª¨ ì…ë ¥ ì‹œ ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
    if ('memo' in entry) {
        const memoInput = document.getElementById('modalMemoInput');
        const memoPreview = document.getElementById('modalMemoPreview');
        if(memoInput && memoPreview) {
            function renderPreview() {
                memoPreview.innerHTML = marked.parse(memoInput.value || '');
            }
            memoInput.addEventListener('input', renderPreview);
            renderPreview();
            memoInput.onchange = function() {
                updateEntryField(entry.id, 'memo', memoInput.value);
            };
        }
    }
}
// ìƒì„¸ ëª¨ë‹¬ìš© ë“œë¡­ë‹¤ìš´ ì˜¤í”ˆ í•¨ìˆ˜
function openDetailDropdown(id, key, btn) {
    let type = '';
    if(key==='category_name') type = 'category';
    else if(key==='region_name') type = 'region';
    else if(key==='status_name') type = 'status';
    else if(key==='subregion') type = 'subregion';
    else if(key==='address') type = 'address';
    // ëª¨ë‹¬ ë‚´ì—ì„œ ë“œë¡­ë‹¤ìš´ì„ ë„ìš°ê¸° ìœ„í•´ ì„ì‹œ td ìƒì„±
    let fakeTd = document.createElement('td');
    fakeTd.style.position = 'fixed';
    fakeTd.style.left = (btn.getBoundingClientRect().left + window.scrollX) + 'px';
    fakeTd.style.top = (btn.getBoundingClientRect().top + window.scrollY + btn.offsetHeight) + 'px';
    document.body.appendChild(fakeTd);
    // openDropdownì€ td, type, id, currentId, currentSubregion ìˆœì„œ
    let currentId = btn.innerText;
    let currentSubregion = '';
    if(type==='subregion') {
        // region_nameì„ ì°¾ì•„ì„œ ì „ë‹¬
        const regionVal = btn.closest('table').querySelector('button[onclick*="region_name"]').innerText;
        currentId = regionVal;
        currentSubregion = btn.innerText;
    }
    openDropdown(fakeTd, type, id, currentId, currentSubregion);
    // ë“œë¡­ë‹¤ìš´ì—ì„œ ê°’ ì„ íƒ í›„ ëª¨ë‹¬ë„ ê°±ì‹ 
    function afterUpdateAll(id) {
        fetch('/update/?id='+id)
        .then(r=>r.json())
        .then(function(data){
            if(data.success && data.entry) {
                showDetailModal(data.entry);
                updateTableRow(data.entry);
                refreshKanban();
            }
        });
    }
    // ë“œë¡­ë‹¤ìš´ ë‹«í ë•Œ fakeTdë„ ì œê±°
    const observer = new MutationObserver(function() {
        if(!document.body.contains(fakeTd)) observer.disconnect();
        if(!dropdown || !document.body.contains(dropdown)) {
            fakeTd.remove();
            observer.disconnect();
        }
    });
    observer.observe(document.body, {childList:true, subtree:true});

    // ë“œë¡­ë‹¤ìš´ì—ì„œ ê°’ ì„ íƒ ì‹œ afterUpdateAllì„ í˜¸ì¶œí•˜ë„ë¡ openDropdown ë‚´ë¶€ì— ì½œë°±ì„ ì „ë‹¬
    // openDropdownì—ì„œ ê°’ì„ ì„ íƒí•˜ëŠ” ë¶€ë¶„ì— ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€:
    // if (typeof window._modalAfterUpdateAll === 'function') window._modalAfterUpdateAll(id);
    window._modalAfterUpdateAll = afterUpdateAll;
}
function updateEntryField(id, field, value) {
    fetch('/update/', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'id='+encodeURIComponent(id)+'&field='+encodeURIComponent(field)+'&value='+encodeURIComponent(value)
    })
    .then(r=>r.json())
    .then(function(data){
        if(!data.success) {
            alert('ìˆ˜ì • ì‹¤íŒ¨: '+(data.error||''));
            return;
        }
        // í•­ìƒ ìµœì‹  entryë¡œ ëª¨ë‹¬/í…Œì´ë¸”/ë³´ë“œ ë™ê¸°í™”
        return fetch('/update/?id='+id);
    })
    .then(r => r ? r.json() : null)
    .then(function(data){
        if(data && data.success && data.entry) {
            showDetailModal(data.entry);
            updateTableRow(data.entry);
            refreshKanban();
            if(field === 'fu_date' && window.calendar) window.calendar.refetchEvents();
        }
    })
    .catch(function(err){
        alert('ìˆ˜ì • ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
        console.error(err);
    });
}
function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
    bindTableCellEvents(); // ...ë²„íŠ¼ ì´ë²¤íŠ¸ ë³µêµ¬
}
function updateTableRow(entry) {
    const tr = document.querySelector(`#entryTbody tr[data-id='${entry.id}']`);
    if(tr) {
        const fieldMap = {
            name: 'name',
            category: 'category',
            region: 'region',
            subregion: 'subregion',
            address: 'address',
            manager: 'manager',
            phone: 'phone',
            email: 'email',
            ta_date: 'ta_date',
            meeting_date: 'meeting_date',
            fu_date: 'fu_date',
            status: 'status',
            possibility: 'possibility',
            amount: 'amount'
        };
        for(const key in fieldMap) {
            const td = tr.querySelector(`td[data-field='${fieldMap[key]}']`);
            if(!td) continue;
            if(key==='category') {
                td.innerText = entry.category_name || '';
                td.setAttribute('data-value', entry.category_id || '');
                if(entry.category_color) {
                    td.style.background = hexToRgba(entry.category_color, 0.18);
                } else {
                    td.style.background = '';
                }
            } else if(key==='region') {
                td.innerText = entry.region_name || '';
                td.setAttribute('data-value', entry.region_id || '');
                td.style.background = '';
            } else if(key==='status') {
                td.innerText = entry.status_name || '';
                td.setAttribute('data-value', entry.status_id || '');
                if(entry.status_color) {
                    td.style.background = hexToRgba(entry.status_color, 0.18);
                } else {
                    td.style.background = '';
                }
            } else if(key==='name') {
                td.innerHTML = `<div class="name-text">${entry.name || ''}</div><div class="more-btn-wrapper"><div class="more-btn" style="cursor:pointer;">â‹¯</div></div>`;
                const newMoreBtn = td.querySelector('.more-btn');
                if(newMoreBtn) {
                    newMoreBtn.onclick = function(e){
                        e.stopPropagation();
                        const tr = td.closest('tr');
                        const id = tr.getAttribute('data-id');
                        if(!id) { alert('ID ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
                        fetch('/update/?id='+id)
                          .then(r => r.text())
                          .then(function(text){
                              try {
                                  const data = JSON.parse(text);
                                  if(data.success) showDetailModal(data.entry);
                                  else alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+(data.error||''));
                              } catch(e) {
                                  alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: JSON íŒŒì‹± ì˜¤ë¥˜');
                                  console.error(e);
                              }
                          })
                          .catch(function(err){
                              alert('ìƒì„¸ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜\n' + err);
                              console.error(err);
                          });
                    };
                }
            } else {
                td.innerText = entry[key] ?? '';
                td.style.background = '';
            }
        }
    }
}
</script>
</body>
</html> 